<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Hello + Camera</title>
    <link rel="stylesheet" href="style1.css">
    <style>
        /* Updated CSS for a simple, working gradient animation */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            padding-top: 24px;
            
            /* Background Gradient Animation */
            background: linear-gradient(270deg, #87CEFA, #ADD8E6, #B0C4DE, #E6E6FA);
            background-size: 800% 800%;
            animation: gradientAnimation 25s ease infinite;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Your existing styles */
        h1 { font-size: 42px; margin: 0; }
        h4 { color: #990000; margin: 0; }
        #videoWrap, #previewWrap {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        video, canvas, img {
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
            max-width: 90%;
            width: 480px;
            height: auto;
        }
        #controls { margin-top: 8px; }
        button { padding: 10px 16px; font-size: 16px; cursor: pointer; }
        #status { font-weight: bold; color: #004466; }
    </style>
</head>
<body>
    <h1>HELLO WORLD</h1>
    <img src="angry-removebg-preview.png" alt="angry" style="max-width:120px;">
    <h4>I GOT YOU! YOU STUPID MONKEY FACE</h4>
    <div id="status">Preparing camera...</div>
    <div id="videoWrap">
        <video id="video" autoplay playsinline></video>
    </div>
    <div id="previewWrap">
        <img id="capturedImg" alt="Captured preview will appear here">
    </div>
    <div id="controls">
        <button id="captureBtn">Capture Now</button>
        <button id="autoCaptureToggle">Auto Capture: ON</button>
        <button id="downloadBtn">Download Photo</button>
    </div>
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvLoaded();"></script>
    <script>
        const video = document.getElementById('video');
        const capturedImg = document.getElementById('capturedImg');
        const status = document.getElementById('status');
        const captureBtn = document.getElementById('captureBtn');
        const autoToggle = document.getElementById('autoCaptureToggle');
        const downloadBtn = document.getElementById('downloadBtn');
        let stream = null;
        let autoCapture = true;
        let openCvReady = false;
        function setStatus(t) {
            status.textContent = t;
        }
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: false });
                video.srcObject = stream;
                await video.play();
                setStatus('Camera is live. Waiting for OpenCV...');
            } catch (err) {
                console.error('Camera start failed:', err);
                setStatus('Cannot access camera. Make sure you allowed permissions and are using HTTPS / localhost.');
            }
        }
        function onOpenCvLoaded() {
            if (typeof cv === 'undefined') {
                setStatus('Failed to load OpenCV.js');
                return;
            }
            cv['onRuntimeInitialized'] = () => {
                openCvReady = true;
                setStatus('OpenCV ready. You can capture a photo.');
                if (autoCapture) {
                    setTimeout(() => {
                        captureFrame();
                    }, 700);
                }
            };
        }
        function captureFrame() {
            if (!stream) {
                setStatus('Camera not started yet.');
                return;
            }
            const tmpCanvas = document.createElement('canvas');
            tmpCanvas.width = video.videoWidth;
            tmpCanvas.height = video.videoHeight;
            const ctx = tmpCanvas.getContext('2d');
            ctx.drawImage(video, 0, 0, tmpCanvas.width, tmpCanvas.height);
            capturedImg.src = tmpCanvas.toDataURL('image/png');
            if (openCvReady) {
                try {
                    let src = cv.imread(tmpCanvas);
                    let dst = new cv.Mat();
                    cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);
                    let ksize = new cv.Size(7, 7);
                    cv.GaussianBlur(src, dst, ksize, 0, 0, cv.BORDER_DEFAULT);
                    src.delete();
                    dst.delete();
                    setStatus('Processed and preview shown. You are famous now.');
                } catch (err) {
                    console.error('OpenCV processing error:', err);
                    setStatus('Processed failed: ' + err);
                }
            } else {
                setStatus('OpenCV not ready yet. Showing unprocessed capture.');
            }
        }
        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.href = capturedImg.src;
            const name = (localStorage.getItem('newUser') || 'user') + '_photo.png';
            link.download = name;
            link.click();
        });
        captureBtn.addEventListener('click', () => {
            captureFrame();
        });
        autoToggle.addEventListener('click', () => {
            autoCapture = !autoCapture;
            autoToggle.textContent = 'Auto Capture: ' + (autoCapture ? 'ON' : 'OFF');
            if (autoCapture && openCvReady) {
                setTimeout(captureFrame, 500);
            }
        });
        (function conditionalAutoCapture() {
            const created = localStorage.getItem('accountCreatedAt');
            if (!created) return;
            const then = new Date(created);
            const now = new Date();
            const diffMs = now - then;
            if (diffMs <= 2 * 60 * 1000) {
                autoCapture = true;
                autoToggle.textContent = 'Auto Capture: ON';
            } else {
                autoCapture = false;
                autoToggle.textContent = 'Auto Capture: OFF';
            }
        })();
        startCamera();
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
            }
        });
    </script>
</body>
</html>